import nodemailer from "nodemailer";

const transporter = nodemailer.createTransport({
  host: process.env.NEXT_SMTP_HOST,
  port: process.env.NEXT_SMTP_PORT,
  secure: true,
  auth: {
    user: process.env.NEXT_SMTP_USER,
    pass: process.env.NEXT_SMTP_PASSWORD,
  },
  tls: {
    rejectUnauthorized: false,
  },
  debug: true,
});

export async function sendOrderConfirmationEmail(orderData) {
  const { customer, order, orderId } = orderData;

  // –†–∞–∑–¥–µ–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã –Ω–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ –∏ —Ü–∏—Ñ—Ä–æ–≤—ã–µ
  const physicalItems = order.items.filter((item) => item.type === "physical");
  const digitalItems = order.items.filter((item) => item.type === "digital");

  // –§–æ—Ä–º–∏—Ä—É–µ–º HTML —Ç–∞–±–ª–∏—Ü—É —Å —Ç–æ–≤–∞—Ä–∞–º–∏
  const itemsTable = `
    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
      <thead>
        <tr style="background-color: #f8f9fa;">
          <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">–¢–æ–≤–∞—Ä</th>
          <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6;">–¢–∏–ø</th>
          <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
          <th style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">–¶–µ–Ω–∞</th>
          <th style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">–°—É–º–º–∞</th>
        </tr>
      </thead>
      <tbody>
        ${order.items
          .map(
            (item) => `
          <tr>
            <td style="padding: 12px; border: 1px solid #dee2e6;">${
              item.name || "–¢–æ–≤–∞—Ä"
            }</td>
            <td style="padding: 12px; text-align: center; border: 1px solid #dee2e6;">
              <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; ${
                item.type === "digital"
                  ? "background-color: #e3f2fd; color: #1976d2;"
                  : "background-color: #f3e5f5; color: #7b1fa2;"
              }">
                ${item.type === "digital" ? "üéÆ –¶–∏—Ñ—Ä–æ–≤–∞—è" : "üì¶ –§–∏–∑–∏—á–µ—Å–∫–∞—è"}
              </span>
            </td>
            <td style="padding: 12px; text-align: center; border: 1px solid #dee2e6;">${
              item.quantity
            }</td>
            <td style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">${item.price.toLocaleString()} ‚Ç∏</td>
            <td style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">${item.total.toLocaleString()} ‚Ç∏</td>
          </tr>
        `
          )
          .join("")}
      </tbody>
      <tfoot>
        <tr style="background-color: #f8f9fa; font-weight: bold;">
          <td colspan="4" style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">–ò—Ç–æ–≥–æ:</td>
          <td style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">${order.totalAmount.toLocaleString()} ‚Ç∏</td>
        </tr>
      </tfoot>
    </table>
  `;

  // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–µ–∫—Ü–∏—é —Å —Ü–∏—Ñ—Ä–æ–≤—ã–º–∏ —Ç–æ–≤–∞—Ä–∞–º–∏ –∏ –¥–∞–Ω–Ω—ã–º–∏ –¥–æ—Å—Ç—É–ø–∞
  const digitalItemsSection =
    digitalItems.length > 0
      ? `
    <div style="background-color: #e3f2fd; border-radius: 8px; padding: 20px; margin-bottom: 30px;">
      <h3 style="color: #1976d2; margin: 0 0 15px 0; font-size: 18px;">üéÆ –¶–∏—Ñ—Ä–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã - –î–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞</h3>
      ${digitalItems
        .map(
          (item) => `
        <div style="background-color: white; border-radius: 6px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #1976d2;">
          <h4 style="margin: 0 0 10px 0; color: #333; font-size: 16px;">${
            item.name
          }</h4>
          ${
            item.digitalData && item.digitalData.platform
              ? `
            <p style="margin: 5px 0; color: #666;"><strong>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:</strong> ${item.digitalData.platform}</p>
          `
              : ""
          }
          ${
            item.digitalData &&
            item.digitalData.credentials &&
            item.digitalData.credentials.length > 0
              ? `
            <div style="margin-top: 10px;">
              <p style="margin: 5px 0; color: #666; font-weight: bold;">–î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞:</p>
              ${item.digitalData.credentials
                .map(
                  (cred, index) => `
                <div style="background-color: #f5f5f5; padding: 10px; border-radius: 4px; margin: 5px 0; font-family: monospace;">
                  <p style="margin: 2px 0; color: #333;"><strong>–õ–æ–≥–∏–Ω:</strong> ${cred.login}</p>
                  <p style="margin: 2px 0; color: #333;"><strong>–ü–∞—Ä–æ–ª—å:</strong> ${cred.password}</p>
                </div>
              `
                )
                .join("")}
            </div>
          `
              : `
            <p style="color: #f57c00; font-style: italic;">–î–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–∞ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 1-2 —á–∞—Å–æ–≤.</p>
          `
          }
        </div>
      `
        )
        .join("")}
      <div style="background-color: #fff3e0; border-radius: 6px; padding: 15px; border-left: 4px solid #ff9800;">
        <p style="margin: 0; color: #e65100; font-weight: bold;">‚ö†Ô∏è –í–∞–∂–Ω–æ:</p>
        <ul style="margin: 10px 0; padding-left: 20px; color: #bf360c;">
          <li>–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–∞ –≤ –Ω–∞–¥–µ–∂–Ω–æ–º –º–µ—Å—Ç–µ</li>
          <li>–ù–µ –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º</li>
          <li>–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º —Å –¥–æ—Å—Ç—É–ø–æ–º —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π</li>
        </ul>
      </div>
    </div>
  `
      : "";

  // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–µ–∫—Ü–∏—é —Å —Ñ–∏–∑–∏—á–µ—Å–∫–∏–º–∏ —Ç–æ–≤–∞—Ä–∞–º–∏
  const physicalItemsSection =
    physicalItems.length > 0
      ? `
    <div style="background-color: #f3e5f5; border-radius: 8px; padding: 20px; margin-bottom: 30px;">
      <h3 style="color: #7b1fa2; margin: 0 0 15px 0; font-size: 18px;">üì¶ –§–∏–∑–∏—á–µ—Å–∫–∏–µ —Ç–æ–≤–∞—Ä—ã - –î–æ—Å—Ç–∞–≤–∫–∞</h3>
      <div style="background-color: white; border-radius: 6px; padding: 15px; border-left: 4px solid #7b1fa2;">
        <p style="margin: 0 0 10px 0; color: #333; font-size: 16px; font-weight: bold;">–í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É!</p>
        <p style="margin: 5px 0; color: #666;">–ù–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è:</p>
        <ul style="margin: 10px 0; padding-left: 20px; color: #666;">
          <li>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π</li>
          <li>–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è —É–¥–æ–±–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –º–µ—Å—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</li>
          <li>–ò–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–∞</li>
        </ul>
        <div style="background-color: #e8f5e8; border-radius: 4px; padding: 10px; margin-top: 15px;">
          <p style="margin: 0; color: #2e7d32; font-weight: bold;">üìû –û–∂–∏–¥–∞–π—Ç–µ –∑–≤–æ–Ω–∫–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 1-2 —á–∞—Å–æ–≤!</p>
        </div>
      </div>
    </div>
  `
      : "";

  const mailOptions = {
    from: `GoldGames <${process.env.NEXT_FEEDBACK_MAIL}>`,
    to: customer.email,
    subject: `‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ #${orderId} - GoldGames`,
    html: `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</title>
      </head>
      <body style="margin: 0; padding: 0; background-color: #f5f5f5; font-family: Arial, sans-serif;">
        <div style="max-width: 600px; margin: 0 auto; background-color: #ffffff; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
          
          <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
          <div style="background: linear-gradient(135deg, #f59e0b, #d97706); padding: 40px 20px; text-align: center;">
            <h1 style="color: white; margin: 0; font-size: 28px; font-weight: bold;">üéÆ GoldGames</h1>
            <p style="color: white; margin: 10px 0 0 0; font-size: 16px; opacity: 0.9;">–í–∞—à –∑–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ–ø–ª–∞—á–µ–Ω!</p>
          </div>
          
          <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
          <div style="padding: 40px 30px;">
            
            <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ -->
            <div style="text-align: center; margin-bottom: 30px;">
              <div style="font-size: 48px; margin-bottom: 15px;">üéâ</div>
              <h2 style="color: #333; margin: 0; font-size: 24px;">–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É!</h2>
              <p style="color: #666; margin: 10px 0 0 0; font-size: 16px;">
                –ó–∞–∫–∞–∑ <strong>#${orderId}</strong> —É—Å–ø–µ—à–Ω–æ –æ–ø–ª–∞—á–µ–Ω –∏ –ø—Ä–∏–Ω—è—Ç –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É
              </p>
            </div>
            
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ -->
            <div style="background-color: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 30px;">
              <h3 style="color: #333; margin: 0 0 15px 0; font-size: 18px;">üìã –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</h3>
              ${itemsTable}
            </div>
            
            <!-- –°–µ–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤ -->
            ${digitalItemsSection}
            ${physicalItemsSection}
            
            <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div style="background-color: #e3f2fd; border-radius: 8px; padding: 20px; margin-bottom: 30px;">
              <h3 style="color: #333; margin: 0 0 15px 0; font-size: 18px;">üìû –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
              <div style="color: #666; line-height: 1.6;">
                <p style="margin: 5px 0;"><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${customer.phone}</p>
                <p style="margin: 5px 0;"><strong>Email:</strong> ${customer.email}</p>
              </div>
            </div>
            
            <!-- –ß—Ç–æ –¥–∞–ª—å—à–µ -->
            <div style="background-color: #f0f9ff; border-left: 4px solid #3b82f6; padding: 20px; margin-bottom: 30px;">
              <h3 style="color: #333; margin: 0 0 15px 0; font-size: 18px;">üöÄ –ß—Ç–æ –¥–∞–ª—å—à–µ?</h3>
              <ul style="color: #666; margin: 0; padding-left: 20px; line-height: 1.6;">
                <li>–ú—ã –æ–±—Ä–∞–±–æ—Ç–∞–µ–º –≤–∞—à –∑–∞–∫–∞–∑ –≤ —Ç–µ—á–µ–Ω–∏–µ 1-2 —á–∞—Å–æ–≤</li>
                <li>–¶–∏—Ñ—Ä–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π email</li>
                <li>–§–∏–∑–∏—á–µ—Å–∫–∏–µ —Ç–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –∞–¥—Ä–µ—Å—É</li>
                <li>–í—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å—Ç–∞—Ç—É—Å–µ –∑–∞–∫–∞–∑–∞</li>
              </ul>
            </div>
            
            <!-- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ -->
            <div style="text-align: center; padding: 20px; background-color: #fafafa; border-radius: 8px;">
              <h3 style="color: #333; margin: 0 0 15px 0; font-size: 18px;">üí¨ –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å?</h3>
              <p style="color: #666; margin: 0 0 15px 0;">–ú—ã –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤—ã –ø–æ–º–æ—á—å –≤–∞–º!</p>
              <div style="margin: 15px 0;">
                <a href="https://wa.me/77477048081" style="display: inline-block; background-color: #25d366; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin: 0 5px; font-weight: bold;">
                  üì± WhatsApp
                </a>
                <a href="mailto:info@goldgames.kz" style="display: inline-block; background-color: #3b82f6; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin: 0 5px; font-weight: bold;">
                  ‚úâÔ∏è Email
                </a>
              </div>
              <p style="color: #999; font-size: 12px; margin: 15px 0 0 0;">
                –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: –ü–ù-–í–° —Å 9:00 –¥–æ 21:00 (GMT+6)
              </p>
            </div>
            
          </div>
          
          <!-- –ü–æ–¥–≤–∞–ª -->
          <div style="background-color: #333; color: white; padding: 20px; text-align: center;">
            <p style="margin: 0; font-size: 14px;">
              ¬© 2024 GoldGames. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.
            </p>
            <p style="margin: 10px 0 0 0; font-size: 12px; opacity: 0.7;">
              –≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–∏—Å—å–º–æ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –æ—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ –Ω–µ–≥–æ.
            </p>
          </div>
          
        </div>
      </body>
      </html>
    `,
  };

  try {
    const info = await transporter.sendMail(mailOptions);
    console.log("Email –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ:", info.response);
    return true;
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ email:", error);
    return false;
  }
}
