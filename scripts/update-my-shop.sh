#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./update-my-shop.sh

set -e  # –ü—Ä–µ—Ä—ã–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
LOG_FILE="${HOME}/my-shop-deploy.log"
exec > >(tee -a "$LOG_FILE") 2>&1

echo "=========================================="
echo "üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è: $(date '+%Y-%m-%d %H:%M:%S')"
echo "=========================================="

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo 'üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è...'

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Node.js
if ! command -v node &> /dev/null; then
  echo '‚ùå Node.js –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'
  exit 1
fi
NODE_VERSION=$(node -v)
echo "‚úÖ Node.js: $NODE_VERSION"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ npm
if ! command -v npm &> /dev/null; then
  echo '‚ùå npm –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'
  exit 1
fi
NPM_VERSION=$(npm -v)
echo "‚úÖ npm: $NPM_VERSION"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ PM2
if ! command -v pm2 &> /dev/null; then
  echo '‚ùå PM2 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: npm install -g pm2'
  exit 1
fi
PM2_VERSION=$(pm2 -v)
echo "‚úÖ PM2: $PM2_VERSION"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Git
if ! command -v git &> /dev/null; then
  echo '‚ùå Git –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'
  exit 1
fi
echo "‚úÖ Git —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
# –ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –∏–∑ –ø–∞–ø–∫–∏ scripts, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ
# –ò–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–æ–º–∞—à–Ω—é—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å package.json)
if [ ! -f "$PROJECT_DIR/package.json" ]; then
  # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –ø—Ä–æ–±—É–µ–º –¥–æ–º–∞—à–Ω—é—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
  PROJECT_DIR="$HOME/my-shop"
  if [ ! -f "$PROJECT_DIR/package.json" ]; then
    echo '‚ùå –ü–∞–ø–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ my-shop –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'
    echo "–ò—Å–∫–∞–ª–∏ –≤: $PROJECT_DIR"
    exit 1
  fi
fi

echo 'üìÅ –ü–µ—Ä–µ—Ö–æ–¥ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞...'
echo "–ü—É—Ç—å: $PROJECT_DIR"
cd "$PROJECT_DIR" || { echo '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞'; exit 1; }

# –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
BACKUP_DIR="$PROJECT_DIR/.backup-$(date +%Y%m%d-%H%M%S)"
if [ -d ".next" ]; then
  echo 'üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏...'
  mkdir -p "$BACKUP_DIR"
  cp -r .next "$BACKUP_DIR/" 2>/dev/null || true
  echo "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: $BACKUP_DIR"
fi

echo 'üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ Git...'
git fetch origin main

echo 'üåø –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –≤–µ—Ç–∫—É main...'
git checkout main || git checkout -b main origin/main

echo 'üóë –û—á–∏—Å—Ç–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π...'
git reset --hard origin/main
git clean -fd

echo '‚úÖ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å origin/main'

echo 'üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2 –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...'
pm2 stop my-shop 2>/dev/null || true
pm2 delete my-shop 2>/dev/null || true
sleep 2

echo 'üóë –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ node_modules –∏ package-lock.json...'
rm -rf node_modules
rm -f package-lock.json
sleep 1

echo 'üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...'
echo "–ù–∞—á–∞–ª–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏: $(date '+%Y-%m-%d %H:%M:%S')"
if timeout 600 npm ci --prefer-offline --no-audit; then
  echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
else
  echo "‚ö†Ô∏è npm ci –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π, –ø—Ä–æ–±—É–µ–º npm install..."
  timeout 600 npm install || { echo '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π'; exit 1; }
fi
echo "–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏: $(date '+%Y-%m-%d %H:%M:%S')"

echo 'üõ† –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞...'
echo "–ù–∞—á–∞–ª–æ —Å–±–æ—Ä–∫–∏: $(date '+%Y-%m-%d %H:%M:%S')"
timeout 900 npm run build || { echo '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ –ø—Ä–æ–µ–∫—Ç–∞'; exit 1; }
echo "–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–±–æ—Ä–∫–∏: $(date '+%Y-%m-%d %H:%M:%S')"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ ! -f ".env.local" ] && [ ! -f ".env.production" ] && [ ! -f ".env" ]; then
  echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: —Ñ–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã."
fi

echo 'üöÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ —á–µ—Ä–µ–∑ PM2...'
# –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
mkdir -p "$PROJECT_DIR/logs"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ PM2
if [ -f "$PROJECT_DIR/ecosystem.config.cjs" ]; then
  echo "üìã –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ecosystem.config.cjs –¥–ª—è PM2"
  pm2 start ecosystem.config.cjs || { echo '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ PM2'; exit 1; }
  echo "‚úÖ PM2 —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ ecosystem.config.cjs"
elif [ -f "$PROJECT_DIR/ecosystem.config.js" ]; then
  echo "üìã –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ecosystem.config.js –¥–ª—è PM2"
  pm2 start ecosystem.config.js || { echo '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ PM2'; exit 1; }
  echo "‚úÖ PM2 —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ ecosystem.config.js"
else
  echo "‚ö†Ô∏è ecosystem.config –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é"
  pm2 start npm --name my-shop -- start || { echo '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ PM2'; exit 1; }
  echo "‚úÖ PM2 —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo 'üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...'
sleep 5
PM2_STATUS=$(pm2 jlist | grep -o '"status":"[^"]*"' | head -1 || echo "")
if echo "$PM2_STATUS" | grep -q "online"; then
  echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
  echo "‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ –∏–ª–∏ –∏–º–µ–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã"
  echo "–°—Ç–∞—Ç—É—Å PM2:"
  pm2 status
  echo "–õ–æ–≥–∏ PM2:"
  pm2 logs my-shop --lines 20 --nostream
  exit 1
fi

# –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3)
echo 'üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π...'
cd "$PROJECT_DIR"
ls -dt .backup-* 2>/dev/null | tail -n +4 | xargs rm -rf 2>/dev/null || true

echo "=========================================="
echo '‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω.'
echo "–í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: $(date '+%Y-%m-%d %H:%M:%S')"
echo "–õ–æ–≥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤: $LOG_FILE"
echo "=========================================="
