name: üöÄ Deploy to Production

on:
  push:
    branches:
      - main  # –î–µ–ø–ª–æ–π —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—É—à–µ –≤ –æ—Å–Ω–æ–≤–Ω—É—é –≤–µ—Ç–∫—É

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      # ==========================
      # 1Ô∏è‚É£ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      # ==========================
      - name: Checkout repository
        uses: actions/checkout@v3

      # ==========================
      # 2Ô∏è‚É£ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js –∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      # ==========================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # ==========================
      # 3Ô∏è‚É£ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      # ==========================
      - name: Install dependencies
        run: npm ci

      # ==========================
      # 4Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏ (–ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ GitHub Actions)
      # ==========================
      - name: Build test
        run: npm run build

      # ==========================
      # 5Ô∏è‚É£ –ó–∞–ø—É—Å–∫ SSH-–∞–≥–µ–Ω—Ç–∞
      # ==========================
      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # ==========================
      # 6Ô∏è‚É£ –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      # ==========================
      - name: Deploy via SSH
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@82.115.49.188 "
            set -e;
            echo 'üìÅ –ü–µ—Ä–µ—Ö–æ–¥ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞...';
            cd ~/my-shop || { echo '‚ùå –ü–∞–ø–∫–∞ my-shop –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'; exit 1; }

            echo 'üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ Git...';
            git fetch origin main;
            git reset --hard origin/main;

            echo 'üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...';
            npm ci;

            echo 'üõ† –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞...';
            npm run build;

            echo 'üöÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ —á–µ—Ä–µ–∑ PM2...';
            pm2 restart my-shop;

            echo '‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω.';
          "

      # ==========================
      # 7Ô∏è‚É£ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –¥–µ–ø–ª–æ–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      # ==========================
      - name: Success message
        if: success()
        run: echo "üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω!"