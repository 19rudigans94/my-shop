name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to server
        timeout-minutes: 25
        run: |
          SERVER_HOST="${{ secrets.SERVER_HOST }}"
          SERVER_USER="${{ secrets.SERVER_USER }}"
          SERVER_HOST="${SERVER_HOST:-82.115.49.188}"
          SERVER_USER="${SERVER_USER:-ubuntu}"
          echo "üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞..."
          if ! ssh -o ConnectTimeout=10 -o BatchMode=yes \
              -o StrictHostKeyChecking=no \
              ${SERVER_USER}@${SERVER_HOST} 'echo "–°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω"' 2>/dev/null; then
            echo "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
            exit 1
          fi
          
          # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–ø–ª–æ—è
          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=30 \
              -o ServerAliveInterval=15 \
              -o ServerAliveCountMax=20 \
              -o BatchMode=yes \
              ${SERVER_USER}@${SERVER_HOST} 'cd ~/my-shop && bash scripts/update-my-shop.sh'
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –¥–µ–ø–ª–æ—è
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è..."
          if ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -o BatchMode=yes \
              ${SERVER_USER}@${SERVER_HOST} 'pm2 describe my-shop | grep -q "online"'; then
            echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
          else
            echo "‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è"
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=10 \
                -o BatchMode=yes \
                ${SERVER_USER}@${SERVER_HOST} 'pm2 status && pm2 logs my-shop --lines 30 --nostream'
            exit 1
          fi
