name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          NEXT_PUBLIC_MONGODB_URI: ${{ secrets.NEXT_PUBLIC_MONGODB_URI }}
          NEXT_SMTP_HOST: ${{ secrets.NEXT_SMTP_HOST }}
          NEXT_SMTP_PORT: ${{ secrets.NEXT_SMTP_PORT }}
          NEXT_SMTP_USER: ${{ secrets.NEXT_SMTP_USER }}
          NEXT_SMTP_PASSWORD: ${{ secrets.NEXT_SMTP_PASSWORD }}
          NEXT_FEEDBACK_MAIL: ${{ secrets.NEXT_FEEDBACK_MAIL }}

      - name: Backup Database
        if: github.ref == 'refs/heads/main'
        run: |
          mkdir -p backups
          mongodump --uri="${{ secrets.MONGODB_URI }}" --out="backups/backup-$(date +%Y%m%d-%H%M%S)"
          tar -czf backups/backup-$(date +%Y%m%d-%H%M%S).tar.gz -C backups backup-$(date +%Y%m%d-%H%M%S)
          rm -rf backups/backup-$(date +%Y%m%d-%H%M%S)

      - name: Deploy to Production
        if: github.ref == 'refs/heads/main'
        run: |
          # Установка PM2
          npm install -g pm2

          # Остановка текущего процесса
          pm2 stop all || true

          # Запуск нового процесса
          pm2 start npm --name "goldgames" -- start

          # Сохранение конфигурации PM2
          pm2 save

          # Настройка автозапуска
          pm2 startup
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          NEXT_PUBLIC_MONGODB_URI: ${{ secrets.NEXT_PUBLIC_MONGODB_URI }}
          NEXT_SMTP_HOST: ${{ secrets.NEXT_SMTP_HOST }}
          NEXT_SMTP_PORT: ${{ secrets.NEXT_SMTP_PORT }}
          NEXT_SMTP_USER: ${{ secrets.NEXT_SMTP_USER }}
          NEXT_SMTP_PASSWORD: ${{ secrets.NEXT_SMTP_PASSWORD }}
          NEXT_FEEDBACK_MAIL: ${{ secrets.NEXT_FEEDBACK_MAIL }}
          NODE_ENV: production

      - name: Health Check
        if: github.ref == 'refs/heads/main'
        run: |
          sleep 10
          curl -f http://localhost:3000 || exit 1
