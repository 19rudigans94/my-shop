name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up SSH agent
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

          #  –ù—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –¥–µ–ø–ª–æ–µ, –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å
      # - name: Copy deploy script to server
      #   run: |
      #     scp -o StrictHostKeyChecking=no ./scripts/update-my-shop.sh ubuntu@82.115.49.188:/home/ubuntu/update-my-shop.sh

      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@82.115.49.188 "
            set -e;
            echo 'üìÅ –ü–µ—Ä–µ—Ö–æ–¥ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞...';
            cd ~/my-shop || { echo '‚ùå –ü–∞–ø–∫–∞ my-shop –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'; exit 1; }
            
            echo 'üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ Git...';
            git fetch origin main;
            echo 'üåø –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –≤–µ—Ç–∫—É main...';
            git checkout main || git checkout -b main origin/main;
            echo 'üóë –û—á–∏—Å—Ç–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π...';
            git reset --hard origin/main;
            git clean -fd;
            echo '‚úÖ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å origin/main';
            
            echo 'üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...';
            npm ci;
            
            echo 'üõ† –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞...';
            npm run build;
            
            echo 'üöÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ —á–µ—Ä–µ–∑ PM2...';
            pm2 restart my-shop;
            
            echo '‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω.';
          "
